<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Linux应急响应</title>
      <link href="/2023/07/19/Linux%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
      <url>/2023/07/19/Linux%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/</url>
      
        <content type="html"><![CDATA[<h1 id="1-排查开机启动项"><a href="#1-排查开机启动项" class="headerlink" title="1.排查开机启动项"></a>1.排查开机启动项</h1><h2 id="相关文件及目录"><a href="#相关文件及目录" class="headerlink" title="相关文件及目录"></a>相关文件及目录</h2><pre class=" language-sh"><code class="language-sh">文件/etc/rc.local/etc/rc.d/rc.local文件夹/etc/rc.d/init.d                #该目录存放了可执行的脚本或文件/etc/rc*.d</code></pre><h2 id="相关指令"><a href="#相关指令" class="headerlink" title="相关指令"></a>相关指令</h2><p>查看开机启动服务</p><pre class=" language-sh"><code class="language-sh">systemctl list-unit-files | grep enable</code></pre><p>关闭恶意服务</p><pre class=" language-sh"><code class="language-sh">sudo systemctl stop [恶意服务]</code></pre><p>删除恶意服务开机启动</p><pre class=" language-sh"><code class="language-sh">sudo systemctl disable [恶意服务]</code></pre><p>关闭错误时还原服务设置</p><pre class=" language-sh"><code class="language-sh">sudo systemctl start [客户服务]sudo systemctl enable [客户服务]</code></pre><hr><h1 id="2-排查系统配置文件"><a href="#2-排查系统配置文件" class="headerlink" title="2.排查系统配置文件"></a>2.排查系统配置文件</h1><h2 id="环境变量配置文件"><a href="#环境变量配置文件" class="headerlink" title="环境变量配置文件"></a>环境变量配置文件</h2><ul><li>/etc/profile</li><li>/etc/bashrc</li><li>/etc/bash.bashrc</li><li>~/.bashrc</li><li>~/.profile</li><li>~/.bash_profile</li><li><del>/.bash_logout<br><img src="/../images/Linux%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/1.png" alt="Pasted image 20230718210849"><br>登录和切换用户时都会加载这些环境变量文件，而在系统登出时则会加载</del>/.bash_logout\</li></ul><hr><h1 id="3-排查资源异常以及进程"><a href="#3-排查资源异常以及进程" class="headerlink" title="3.排查资源异常以及进程"></a>3.排查资源异常以及进程</h1><h2 id="查看所有进程"><a href="#查看所有进程" class="headerlink" title="查看所有进程"></a>查看所有进程</h2><pre class=" language-sh"><code class="language-sh">sudo ps -aux</code></pre><h2 id="查找进程文件位置"><a href="#查找进程文件位置" class="headerlink" title="查找进程文件位置"></a>查找进程文件位置</h2><pre class=" language-sh"><code class="language-sh">sudo lsof -p [PID]                #查看该pid对应进程的详细信息sudo ls -al /proc/pid/exe         #查看该pid对应进程的绝对路径sudo kill -9 [PID]                #杀掉进程</code></pre><table><thead><tr><th align="left">文件</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">cwd</td><td align="left">符号链接的是进程运行目录</td></tr><tr><td align="left">exe</td><td align="left">符号链接的是执行程序的绝对路径</td></tr><tr><td align="left">cmdline</td><td align="left">符号链接的是进程运行目录</td></tr><tr><td align="left">environ</td><td align="left">记录进程运行时系统的环境变量</td></tr></tbody></table><h2 id="查看CPU占用"><a href="#查看CPU占用" class="headerlink" title="查看CPU占用"></a>查看CPU占用</h2><pre class=" language-sh"><code class="language-sh">top</code></pre><h2 id="查看内存"><a href="#查看内存" class="headerlink" title="查看内存"></a>查看内存</h2><pre class=" language-sh"><code class="language-sh">ps -aux | sort -k4nr | head -10</code></pre><hr><h1 id="4-网络排查"><a href="#4-网络排查" class="headerlink" title="4.网络排查"></a>4.网络排查</h1><h2 id="网卡实时流量排查"><a href="#网卡实时流量排查" class="headerlink" title="网卡实时流量排查"></a>网卡实时流量排查</h2><pre class=" language-sh"><code class="language-sh">sudo iftop -i [网卡] -P</code></pre><h2 id="网络连接排查"><a href="#网络连接排查" class="headerlink" title="网络连接排查"></a>网络连接排查</h2><pre class=" language-sh"><code class="language-sh">netstat -antup</code></pre><ul><li>-a 显示所有</li><li>-n 数字形式展示连接端口</li><li>-t 查看tcp连接</li><li>-u 查看udp连接</li><li>-p 显示相关程序名<br>着重查看ESTABLISHED的端口</li></ul><hr><h1 id="5-定时任务排查"><a href="#5-定时任务排查" class="headerlink" title="5.定时任务排查"></a>5.定时任务排查</h1><h2 id="定时任务文件或目录"><a href="#定时任务文件或目录" class="headerlink" title="定时任务文件或目录"></a>定时任务文件或目录</h2><ul><li>/var/spool/cron                                                          </li><li>/etc/crontab                                                            </li><li>/etc/cron.d</li><li>/etc/cron.hourly</li><li>/etc/cron.daily</li><li>/etc/cron.weekly</li><li>/etc/cron.monthly</li></ul><h2 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h2><pre class=" language-sh"><code class="language-sh">crontab -l                             #查看所有crontab计划任务</code></pre><hr><h1 id="6-用户筛查"><a href="#6-用户筛查" class="headerlink" title="6.用户筛查"></a>6.用户筛查</h1><p>检查用户的uid和gid，如果为0着重注意</p><pre class=" language-sh"><code class="language-sh">/etc/passwd</code></pre><p>查看登录用户的时间、ip</p><pre class=" language-sh"><code class="language-sh">who</code></pre><hr><h1 id="7-Rootkit排查"><a href="#7-Rootkit排查" class="headerlink" title="7.Rootkit排查"></a>7.Rootkit排查</h1><h2 id="chkrootkit"><a href="#chkrootkit" class="headerlink" title="chkrootkit"></a>chkrootkit</h2><pre class=" language-sh"><code class="language-sh">sudo apt install chkrootkitsudo chkrootkit</code></pre><h2 id="rkhunter"><a href="#rkhunter" class="headerlink" title="rkhunter"></a>rkhunter</h2><pre class=" language-sh"><code class="language-sh">sudo apt install rkhuntersudo rkhunter --check</code></pre>]]></content>
      
      
      <categories>
          
          <category> 应急响应 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux应急响应 </tag>
            
            <tag> 蓝队 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows建立影子用户</title>
      <link href="/2023/07/15/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/"/>
      <url>/2023/07/15/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们在管理员权限下可以使用<code>net user [username$] [password] /add</code>命令来创建或者删除隐藏用户，因此我们可以利用此方法建立隐藏用户来实现权限维持。但是通过这种方式建立的隐藏用户虽然能逃过<code>net user</code>的检查，在本地用户和组中暴露无遗。为了更好的建立隐藏用户，我们需要修改注册表相关内容。</p><h1 id="创建过程"><a href="#创建过程" class="headerlink" title="创建过程"></a>创建过程</h1><h2 id="1-创建常规隐藏用户并提升权限"><a href="#1-创建常规隐藏用户并提升权限" class="headerlink" title="1.创建常规隐藏用户并提升权限"></a>1.创建常规隐藏用户并提升权限</h2><p>创建隐藏用户<code>test$</code>，并将密码设置为123</p><pre class=" language-powershell"><code class="language-powershell">net user test$ 123 <span class="token operator">/</span>add</code></pre><p>将test$用户加入高权限的管理员组</p><pre class=" language-powershell"><code class="language-powershell">net localgroup administrators test$ <span class="token operator">/</span>add</code></pre><p>将test$用户退出低权限的用户组</p><pre class=" language-powershell"><code class="language-powershell">net localgroup users test$ <span class="token operator">/</span><span class="token function">del</span></code></pre><p><img src="/../images/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/1.png"></p><p><img src="/../images/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/2.png"></p><p>很清楚地看见<code>net user</code>无法检测我们刚刚生成的隐藏用户，但是本地用户和组中能看见</p><h2 id="2-修改注册表"><a href="#2-修改注册表" class="headerlink" title="2.修改注册表"></a>2.修改注册表</h2><h3 id="修改注册表SAM的权限"><a href="#修改注册表SAM的权限" class="headerlink" title="修改注册表SAM的权限"></a>修改注册表SAM的权限</h3><p>将<code>SAM</code>的<code>Administrators</code>组权限设置为完全控制，重新打开注册表（或者按F5刷新）即可看见<code>SAM</code>下面的项</p><p><img src="/../images/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/3.png"></p><h3 id="替换隐藏用户属性为管理员"><a href="#替换隐藏用户属性为管理员" class="headerlink" title="替换隐藏用户属性为管理员"></a>替换隐藏用户属性为管理员</h3><p>首先在<code>Names</code>项中将事先添加的隐藏用户<code>test$</code>导出保存为<code>1.reg</code></p><p><img src="/../images/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/4.png"></p><p>再通过<code>Names</code>项中用户的值去将<code>Users</code>项中<code>test$</code>和管理员用户<code>Administrator</code>注册表进行导出（比如<code>test$</code>的值为<code>0x3ec</code>，我们将<code>USers</code>项中的<code>000003EC</code>导出）</p><p><img src="/../images/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/5.png"></p><p>将<code>000003EC</code>保存为<code>2.reg</code></p><p><img src="/../images/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/6.png"></p><p>将<code>Administrator</code>对应的<code>000001F4</code>保存为<code>admin.reg</code></p><p><img src="/../images/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/7.png"></p><p>将<code>2.reg</code>中<code>F</code>的值替换为<code>admin.reg</code>中<code>F</code>的值（将黄色部分替换为红色部分）</p><p><img src="/../images/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/8.png"></p><h3 id="删除隐藏用户，导入隐藏用户注册表"><a href="#删除隐藏用户，导入隐藏用户注册表" class="headerlink" title="删除隐藏用户，导入隐藏用户注册表"></a>删除隐藏用户，导入隐藏用户注册表</h3><p>将隐藏用户删除</p><pre class=" language-powershell"><code class="language-powershell">net user test$ <span class="token operator">/</span><span class="token function">del</span></code></pre><p>将<code>1.reg</code>和<code>2.reg</code>导入注册表（双击即可）</p><p>此时我们查看本地用户和组并未发现<code>test$</code>账户，但使用<code>net user test$</code>可以查看到说明我们影子用户添加完成</p><p><img src="/../images/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/9.png"></p><p>此时我们就实现权限维持，后续可以利用远程登录登入受害者主机</p><h1 id="排查方法"><a href="#排查方法" class="headerlink" title="排查方法"></a>排查方法</h1><p>利用<code>vmic</code>命令即可查到所有用户</p><pre class=" language-powershell"><code class="language-powershell">wmic useraccount get name<span class="token punctuation">,</span>sid</code></pre><p><img src="/../images/Windows%E5%BB%BA%E7%AB%8B%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7/10.png"></p><p>排查到以后可以将影子用户删除或者改密</p><pre class=" language-powershell"><code class="language-powershell">net user test$ <span class="token operator">/</span><span class="token function">del</span>net user test$ <span class="token punctuation">[</span>密码<span class="token punctuation">]</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 权限维持 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows后门 </tag>
            
            <tag> 权限维持 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
